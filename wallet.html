<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Wallet</title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
  <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f0f2f5;
    }
    .wallet-container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    h1 {
      font-size: 24px;
    }
    .wallet-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    .wallet-actions button {
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background-color: #102F49;
      color: white;
      cursor: pointer;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }
    .close {
      float: right;
      cursor: pointer;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="wallet-container">
    <h1 id="welcomeText">Welcome</h1>
    <h2>My Wallet</h2>
    <p id="balanceDisplay">₦0</p>
    <div class="wallet-actions">
      <button id="sendBtn">Send</button>
      <button id="receiveBtn">Receive</button>
      <button id="goBackBtn"><i class="fas fa-arrow-left"></i> Go Back</button>
    </div>
    <div id="transactionsContainer"></div>
  </div>  <!-- Send Modal -->  <div id="sendModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('sendModal')">&times;</span>
      <h2>Send Money</h2>
      <input id="toUser" placeholder="Recipient Username" />
      <input id="amount" placeholder="Amount" type="number" />
      <button onclick="sendMoney()">Send</button>
    </div>
  </div>  <!-- Receive Modal -->  <div id="receiveModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('receiveModal')">&times;</span>
      <h2>Receive Money</h2>
      <p>Ask the sender to send to your username: <strong id="receiveUsername"></strong></p>
    </div>
  </div>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, get, update, push, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      // your Firebase config here
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase();

    const username = localStorage.getItem('username');
    document.getElementById('welcomeText').textContent = `Welcome ${username}`;

    const balanceRef = ref(db, `/balance/teams/${username}`);
    onValue(balanceRef, (snapshot) => {
      const balance = snapshot.val() || 0;
      document.getElementById('balanceDisplay').textContent = `₦${balance}`;
    });

    const txRef = ref(db, `/balance/teams/${username}/transactions`);
    onValue(txRef, (snapshot) => {
      const data = snapshot.val() || {};
      const container = document.getElementById('transactionsContainer');
      container.innerHTML = '<h3>Transaction History</h3>';
      Object.values(data).reverse().forEach(tx => {
        container.innerHTML += `<p>${tx.type === 'send' ? 'Sent' : 'Received'} ₦${tx.amount} ${tx.type === 'send' ? 'to' : 'from'} ${tx.type === 'send' ? tx.to : tx.from}</p>`;
      });
    });

    document.getElementById("sendBtn").onclick = () => {
      document.getElementById("sendModal").style.display = "flex";
    };

    document.getElementById("receiveBtn").onclick = () => {
      document.getElementById("receiveUsername").textContent = username;
      document.getElementById("receiveModal").style.display = "flex";
    };

    document.getElementById("goBackBtn").onclick = () => {
      window.location.href = "more.html";
    };

    window.closeModal = (id) => {
      document.getElementById(id).style.display = 'none';
    };

    window.sendMoney = async () => {
      const toUser = document.getElementById('toUser').value.trim();
      const amount = Number(document.getElementById('amount').value);

      if (!toUser || !amount || isNaN(amount)) return alert("Invalid input");

      const senderRef = ref(db, `/balance/teams/${username}`);
      const receiverRef = ref(db, `/balance/teams/${toUser}`);
      const senderSnap = await get(senderRef);
      const receiverSnap = await get(receiverRef);

      const senderBal = senderSnap.val() || 0;
      const receiverBal = receiverSnap.val() || 0;

      if (senderBal < amount) return alert("Insufficient balance");

      await update(ref(db, `/balance/teams`), {
        [username]: senderBal - amount,
        [toUser]: receiverBal + amount
      });

      const tx = {
        type: 'send',
        from: username,
        to: toUser,
        amount,
        timestamp: new Date().toISOString()
      };

      const newKey = push(child(ref(db), `balance/teams/${username}/transactions`)).key;

      await update(ref(db), {
        [`balance/teams/${username}/transactions/${newKey}`]: tx,
        [`balance/teams/${toUser}/transactions/${newKey}`]: { ...tx, type: 'receive' }
      });

      // Email Notifications
      const userEmailSnap = await get(ref(db, `/balance/teams/${toUser}/email`));
      const senderEmailSnap = await get(ref(db, `/balance/teams/${username}/email`));

      const receiverEmail = userEmailSnap.val();
      const senderEmail = senderEmailSnap.val();

      emailjs.send("service_cvgwdjb", "template_9yx9srx", {
        from_user: username,
        to_user: toUser,
        amount: amount,
        to_email: receiverEmail,
        from_email: senderEmail,
        other_user: toUser
      });

      emailjs.send("service_cvgwdjb", "template_9yx9srx", {
        from_user: username,
        to_user: toUser,
        amount: amount,
        to_email: senderEmail,
        from_email: receiverEmail,
        other_user: username
      });

      closeModal("sendModal");
    };
  </script></body>
</html>
