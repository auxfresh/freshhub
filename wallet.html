<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wallet</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: linear-gradient(to bottom right, #0f2027, #203a43, #2c5364);
      color: white;
      padding: 20px;
    }
    .wallet-box {
      background: #102F49;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      margin: auto;
      text-align: center;
      box-shadow: 0 0 20px rgba(0, 191, 255, 0.3);
    }
    h1 {
      margin-bottom: 10px;
    }
    .balance {
      font-size: 2.2rem;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .buttons button {
      margin: 10px;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      background: #00bcd4;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .buttons button:hover {
      background: #0097a7;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #102f49;
      padding: 30px;
      border-radius: 15px;
      text-align: left;
      width: 300px;
      color: white;
    }
    .modal-content input {
      width: 100%;
      margin-top: 10px;
      margin-bottom: 20px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #2c5364;
      color: white;
    }
    .modal-content button {
      padding: 10px;
      width: 100%;
      border-radius: 8px;
      border: none;
      background: #00bcd4;
      color: white;
      font-weight: bold;
    }
    .close {
      float: right;
      cursor: pointer;
      font-size: 18px;
    }
    .transactions {
      margin-top: 40px;
      text-align: left;
    }
    .transaction {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px 20px;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .transaction span {
      display: block;
    }
    .go-back-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #102F49;
      color: #fff;
      border: none;
      border-radius: 30px;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .go-back-btn:hover {
      background-color: #0d2538;
      transform: translateX(-3px);
    }
    .welcome-message {
      font-size: 30px;
      font-family: fantasy;  
      font-weight: bold;
      color: #00ffff;
      text-align: center;
      margin-bottom: 10px;
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .floating-help-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #102F49;
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 50px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 999;
      transition: background 0.3s ease;
    }
    .floating-help-btn:hover {
      background: #0a1c30;
    }
    .help-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }
    .help-modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      font-size: 14px;
      color: #333;
      line-height: 1.6;
      position: relative;
    }
    .help-modal-content h2 {
      margin-top: 0;
      color: #102F49;
    }
    .help-modal-content ul {
      padding-left: 20px;
    }
    .close-btn {
      position: absolute;
      top: 10px; right: 15px;
      font-size: 22px;
      color: #333;
      cursor: pointer;
    }
  </style>

  <!-- EmailJS SDK -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("017c9GlwpBSK92Tuv"); // Your EmailJS public key
    })();
  </script>
</head>
<body>

<div class="wallet-box">
  <div id="welcomeMessage" class="welcome-message"></div>

  <h1>My Wallet</h1>
  <div class="balance" id="balanceDisplay">‚Ç¶0</div>
  <div class="buttons">
    <button onclick="showModal('sendModal')">Send</button>
    <button onclick="showModal('receiveModal')">Receive</button>
    <button id="goBackBtn" class="go-back-btn" style="display:none;">
      <i class="fas fa-arrow-left"></i> Go Back
    </button>
  </div> 

  <div class="transactions">
    <h3>Transaction History</h3>
    <div id="transactionList"></div>
  </div>
</div>

<!-- Floating Help Button -->
<button id="helpBtn" class="floating-help-btn">
  <i class="fas fa-info-circle"></i> How to Use
</button>

<!-- Help Modal -->
<div id="helpModal" class="help-modal">
  <div class="help-modal-content">
    <span class="close-btn" id="helpCloseBtn">&times;</span>
    <h2>How to Use Your Wallet</h2>
    <ul>
      <li><strong>üîê Login Daily To Earn:</strong> Every day you log in for the first time, you‚Äôll automatically earn ‚Ç¶50.<br>
This reward is added to your balance once per day.</li>
      <li><strong>üí∞ View Your Balance:</strong> Your current balance is shown at the top of your wallet.<br>
It updates automatically when you send, receive, or withdraw money.</li>
      <li><strong>üì§ Send Money:</strong>Click the Send button.<br>
Enter the username of the recipient and the amount you want to send.<br>
Make sure the recipient‚Äôs username exists.<br>
The amount will be deducted from your balance and added to theirs.</li>
      <li><strong>üì• Receive Money:</strong>Share your username with others so they can send you money.
When someone sends you funds, your balance will update immediately.</li>
      <li><strong>üí≥ Withdraw:</strong>Withdraw Funds
Click the Withdraw button.<br>
Enter the amount you want to withdraw.<br>
The amount will be subtracted from your wallet.</li>
      <li><strong>üìÉ Transaction History:</strong>Scroll down to see all recent Send, Receive, and Withdraw activities.<br>
Each transaction includes type, amount, and date.</li>
      <li><strong>üîô Go Back:</strong>Use the ‚Üê Go Back button under Send/Receive to return to the main dashboard.</li>
    </ul>
  </div>
</div>

<!-- Send Modal -->
<div class="modal" id="sendModal">
  <div class="modal-content">
    <span class="close" onclick="hideModal('sendModal')">&times;</span>
    <h3>Send Money</h3>
    <input type="text" id="sendToUser" placeholder="Recipient Username" />
    <input type="number" id="sendAmount" placeholder="Amount" />
    <button onclick="sendMoney()">Send</button>
  </div>
</div>

<!-- Receive Modal -->
<div class="modal" id="receiveModal">
  <div class="modal-content">
    <span class="close" onclick="hideModal('receiveModal')">&times;</span>
    <h3>Your Username</h3>
    <p id="yourUsername" style="font-size: 18px; font-weight: bold;"></p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, ref, get, set, update, onValue, push } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

  // Firebase config - replace with your actual config
  const firebaseConfig = {
    apiKey: "AIzaSyBWUjKRUpiLmwRi7UjQ5l_zCJ1YOGsaIg0",
    authDomain: "fresh-hub-d509f.firebaseapp.com",
    databaseURL: "https://fresh-hub-d509f-default-rtdb.firebaseio.com",
    projectId: "fresh-hub-d509f",
    storageBucket: "fresh-hub-d509f.appspot.com",
    messagingSenderId: "101887757266",
    appId: "1:101887757266:web:80c054959f6588771fd60b"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Grab from localStorage
  const username = localStorage.getItem('username');
  const welcomeMessageEl = document.getElementById('welcomeMessage');
  const balanceDisplay = document.getElementById('balanceDisplay');
  const transactionList = document.getElementById('transactionList');
  const yourUsernameEl = document.getElementById('yourUsername');
  const goBackBtn = document.getElementById('goBackBtn');

  if (!username) {
    alert('No username found. Please login first.');
    // Redirect or handle as needed
  } else {
    yourUsernameEl.textContent = username;
    welcomeMessageEl.textContent = `Welcome back, ${username}!`;
  }

  // Reference paths for user data
  const userRef = ref(db, `/blance/teams/${username}`);
  const balanceRef = ref(db, `/balance/teams/${username}/balance`);
  const transactionsRef = ref(db, `/balance/teams/${username}/transactions`);

  // Show user balance
  function updateBalanceDisplay(value) {
    balanceDisplay.textContent = `‚Ç¶${value.toLocaleString()}`;
  }

  // Load and listen for balance changes
  onValue(balanceRef, (snapshot) => {
    const balance = snapshot.val() ?? 0;
    updateBalanceDisplay(balance);
  });

  // Load transaction history
  function loadTransactions() {
    get(transactionsRef).then(snapshot => {
      const data = snapshot.val();
      transactionList.innerHTML = "";
      if (!data) {
        transactionList.textContent = "No transactions yet.";
        return;
      }
      const transactions = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
      transactions.forEach(tx => {
        const div = document.createElement('div');
        div.className = 'transaction';
        div.innerHTML = `
          <span><strong>Type:</strong> ${tx.type}</span>
          <span><strong>Amount:</strong> ‚Ç¶${tx.amount.toLocaleString()}</span>
          <span><strong>Date:</strong> ${new Date(tx.timestamp).toLocaleString()}</span>
          ${tx.toUser ? `<span><strong>To:</strong> ${tx.toUser}</span>` : ''}
          ${tx.fromUser ? `<span><strong>From:</strong> ${tx.fromUser}</span>` : ''}
        `;
        transactionList.appendChild(div);
      });
    });
  }

  loadTransactions();

  // Show/Hide modal helpers
  function showModal(id) {
    document.getElementById(id).style.display = "flex";
    goBackBtn.style.display = "inline-flex";
  }
  function hideModal(id) {
    document.getElementById(id).style.display = "none";
    goBackBtn.style.display = "none";
  }

  goBackBtn.onclick = () => {
    // Hide all modals when going back
    ['sendModal','receiveModal'].forEach(id => hideModal(id));
  };

  // Send money function
  async function sendMoney() {
    const toUser = document.getElementById('sendToUser').value.trim();
    const amount = Number(document.getElementById('sendAmount').value);

    if (!toUser || amount <= 0) {
      alert('Please enter a valid username and amount.');
      return;
    }
    if (toUser === username) {
      alert("You can't send money to yourself.");
      return;
    }

    // Fetch sender balance and recipient data
    const senderSnapshot = await get(userRef);
    if (!senderSnapshot.exists()) {
      alert("Sender data not found.");
      return;
    }
    const senderData = senderSnapshot.val();
    if (!senderData.balance || senderData.balance < amount) {
      alert("Insufficient balance.");
      return;
    }

    const recipientRef = ref(db, `/balance/teams/${toUser}`);
    const recipientSnapshot = await get(recipientRef);
    if (!recipientSnapshot.exists()) {
      alert("Recipient username does not exist.");
      return;
    }

    // All good, proceed to update balances and transactions atomically
    const updates = {};

    // Deduct from sender
    updates[`/balance/teams/${username}/balance`] = senderData.balance - amount;
    // Add to recipient balance
    const recipientData = recipientSnapshot.val();
    const recipientBalance = recipientData.balance ?? 0;
    updates[`/balance/teams/${toUser}/balance`] = recipientBalance + amount;

    const timestamp = Date.now();

    // Push transaction for sender (Send)
    const senderTxKey = push(ref(db, `/balance/teams/${username}/transactions`)).key;
    updates[`/balance/teams/${username}/transactions/${senderTxKey}`] = {
      type: "Send",
      amount,
      toUser,
      timestamp,
    };

    // Push transaction for recipient (Receive)
    const recipientTxKey = push(ref(db, `/balance/teams/${toUser}/transactions`)).key;
    updates[`/balance/teams/${toUser}/transactions/${recipientTxKey}`] = {
      type: "Receive",
      amount,
      fromUser: username,
      timestamp,
    };

    try {
      await update(ref(db), updates);
      alert(`Successfully sent ‚Ç¶${amount.toLocaleString()} to ${toUser}.`);
      // Refresh transaction list and balance
      loadTransactions();
      hideModal('sendModal');
      // Clear inputs
      document.getElementById('sendToUser').value = "";
      document.getElementById('sendAmount').value = "";

      // Send EmailJS notification to sender
      sendEmailNotification(username, toUser, amount);

    } catch (error) {
      console.error("Transaction failed:", error);
      alert("Transaction failed. Please try again.");
    }
  }

  // EmailJS send function for Send transaction notification
  function sendEmailNotification(fromUser, toUser, amount) {
    // Fetch sender email and recipient email from DB for emails
    Promise.all([
      get(ref(db, `/balance/teams/${fromUser}/email`)),
      get(ref(db, `/balance/teams/${toUser}/email`))
    ]).then(([senderEmailSnap, recipientEmailSnap]) => {
      const senderEmail = senderEmailSnap.val();
      const recipientEmail = recipientEmailSnap.val();

      if (!senderEmail) {
        console.warn("Sender email not found; skipping email notification.");
        return;
      }

      // Prepare EmailJS params
      const templateParams = {
        from_username: fromUser,
        to_username: toUser,
        amount: amount.toLocaleString(),
        from_email: senderEmail,
        to_email: recipientEmail || "",
        date: new Date().toLocaleString(),
      };

      emailjs.send('service_cvgwdjb', 'template_9yx9srx', templateParams)
      .then(() => {
        console.log("Email notification sent successfully.");
      }, (error) => {
        console.error("Email notification error:", error);
      });

    }).catch(err => {
      console.error("Failed to fetch emails for notification:", err);
    });
  }

  // Help modal controls
  const helpBtn = document.getElementById('helpBtn');
  const helpModal = document.getElementById('helpModal');
  const helpCloseBtn = document.getElementById('helpCloseBtn');

  helpBtn.onclick = () => {
    helpModal.style.display = 'flex';
  };
  helpCloseBtn.onclick = () => {
    helpModal.style.display = 'none';
  };
  window.onclick = (e) => {
    if (e.target === helpModal) helpModal.style.display = 'none';
  };
  window.showModal = id => document.getElementById(id).style.display = "flex";
  window.hideModal = id => document.getElementById(id).style.display = "none";
</script>
</body>
</html>
